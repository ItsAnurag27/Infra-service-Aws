name: Jenkins Installation Verification

on:
  workflow_run:
    workflows: ["Terraform Deploy AWS Services"]
    types:
      - completed

jobs:
  verify-jenkins:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get latest EC2 public IP
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" "Name=tag:Name,Values=15-services-*" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "‚úÖ EC2 IP: $EC2_IP"

      - name: Wait for Jenkins to be ready (up to 5 minutes)
        run: |
          echo "Waiting for Jenkins to complete PHASE 1+2 installation..."
          for i in {1..300}; do
            if curl -s -f -m 5 http://${{ steps.get-ip.outputs.ec2_ip }}:8080 >/dev/null 2>&1; then
              echo "‚úÖ Jenkins is responding!"
              exit 0
            fi
            if [ $((i % 60)) -eq 0 ]; then
              echo "  Still waiting... ($i/300 seconds elapsed)"
            fi
            sleep 1
          done
          echo "‚è≥ Jenkins is still initializing (installation in progress)"

      - name: Print deployment summary
        if: always()
        run: |
          echo "======================================"
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "======================================"
          echo ""
          echo "üìä INFRASTRUCTURE:"
          echo "  EC2 IP: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  EC2 Instance: Running"
          echo "  Docker: Installed ‚úÖ"
          echo "  Docker Compose: Installed ‚úÖ"
          echo "  Jenkins: Auto-installing via Terraform user_data ‚úÖ"
          echo ""
          echo "üåê ACCESS JENKINS:"
          echo "  URL: http://${{ steps.get-ip.outputs.ec2_ip }}:8080"
          echo "  Port: 8080"
          echo ""
          echo "üìù NEXT STEPS:"
          echo "  1. Open http://${{ steps.get-ip.outputs.ec2_ip }}:8080 in browser"
          echo "  2. Jenkins will initialize (may take 2-3 minutes)"
          echo "  3. Unlock with initial admin password"
          echo ""
          echo "üí° SSH TO EC2 FOR LOGS:"
          echo "  ssh -i demo.pem ec2-user@${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  tail -f /var/log/setup.log"
          echo ""
          echo "======================================"
