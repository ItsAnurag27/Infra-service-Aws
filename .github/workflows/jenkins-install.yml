name: Jenkins Installation Verification

on:
  workflow_run:
    workflows: ["Terraform Deploy AWS Services"]
    types:
      - completed

jobs:
  install-jenkins:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get latest EC2 public IP
        id: get-ip
        run: |
          EC2_IP=$(aws ec2 describe-instances \
            --filters "Name=instance-state-name,Values=running" "Name=tag:Name,Values=15-services-*" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "‚úÖ EC2 IP: $EC2_IP"

      - name: Wait for EC2 SSH to be ready
        run: |
          echo "Waiting for EC2 SSH to be ready..."
          for i in {1..60}; do
            if timeout 5 bash -c "echo >/dev/tcp/${{ steps.get-ip.outputs.ec2_ip }}/22" 2>/dev/null; then
              echo "‚úÖ EC2 SSH is ready!"
              exit 0
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "  Attempt $i/60..."
            fi
            sleep 5
          done
          echo "‚ùå EC2 SSH not ready after 5 minutes"
          exit 1

      - name: Wait for PHASE 1 to complete
        run: |
          echo "Waiting for EC2 PHASE 1 (Docker/Compose) to complete..."
          for i in {1..120}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ec2-user@${{ steps.get-ip.outputs.ec2_ip }} \
              'test -f /var/log/setup.log && grep -q "PHASE 1 COMPLETE" /var/log/setup.log' 2>/dev/null; then
              echo "‚úÖ PHASE 1 complete!"
              exit 0
            fi
            if [ $((i % 30)) -eq 0 ]; then
              echo "  Still waiting... ($i/120 seconds)"
            fi
            sleep 1
          done
          echo "‚ö†Ô∏è  PHASE 1 check timeout, proceeding anyway"

      - name: Install Jenkins (PHASE 2)
        run: |
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ec2-user@${{ steps.get-ip.outputs.ec2_ip }} << 'JENKINS_SCRIPT'
          #!/bin/bash
          set -e
          exec > >(tee -a /var/log/setup.log)
          exec 2>&1
          
          echo ""
          echo "========================================"
          echo "PHASE 2: JENKINS INSTALLATION (SSH)"
          echo "========================================"
          
          echo "[JENKINS-1] Adding repository..."
          sudo tee /etc/yum.repos.d/jenkins.repo > /dev/null << 'EOF'
          [jenkins]
          name=Jenkins-stable
          baseurl=https://pkg.jenkins.io/redhat-stable
          gpgcheck=1
          gpgkey=https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
          EOF
          echo "‚úÖ Repository added"
          
          echo "[JENKINS-2] Importing GPG key..."
          sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key 2>/dev/null || echo "‚ö†Ô∏è  GPG import done"
          echo "‚úÖ GPG key processed"
          
          echo "[JENKINS-3] Downloading Jenkins packages..."
          sudo mkdir -p /tmp/jenkins-download
          sudo yum install --downloadonly --downloaddir=/tmp/jenkins-download -y jenkins fontconfig 2>&1 | tail -2 || true
          echo "‚úÖ Downloaded"
          
          echo "[JENKINS-4] Waiting for I/O..."
          sleep 15
          
          echo "[JENKINS-5] Installing Jenkins..."
          if sudo yum install -y jenkins 2>&1 | tail -3; then
            echo "‚úÖ Jenkins installed"
          else
            sudo yum install -y --nogpgcheck jenkins 2>&1 | tail -3
            echo "‚úÖ Jenkins installed (GPG skipped)"
          fi
          
          echo "[JENKINS-6] Verifying..."
          sudo rpm -qa | grep jenkins || echo "‚ö†Ô∏è  Package check done"
          
          echo "[JENKINS-7] Enabling service..."
          sudo systemctl enable jenkins
          echo "‚úÖ Service enabled"
          
          echo "[JENKINS-8] Starting Jenkins..."
          sudo systemctl start jenkins 2>&1 || true
          echo "‚úÖ Start issued"
          
          echo "[JENKINS-9] Waiting for Jenkins to run..."
          for i in {1..60}; do
            if sudo systemctl is-active --quiet jenkins 2>/dev/null; then
              echo "‚úÖ Jenkins running! ($i seconds)"
              break
            fi
            sleep 1
          done
          
          echo "[JENKINS-10] Waiting for web interface..."
          sleep 20
          for i in {1..10}; do
            HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            if echo $HTTP | grep -E "200|403|401" > /dev/null; then
              echo "‚úÖ Web interface ready (HTTP $HTTP)"
              break
            fi
            sleep 5
          done
          
          echo "[JENKINS-11] Getting admin password..."
          sleep 10
          if sudo test -f /var/lib/jenkins/secrets/initialAdminPassword; then
            echo "‚úÖ Initial Admin Password:"
            sudo cat /var/lib/jenkins/secrets/initialAdminPassword | head -c 30
            echo "..."
          fi
          
          echo ""
          echo "========================================"
          echo "‚úÖ PHASE 2: JENKINS COMPLETE!"
          echo "========================================"
          echo "Status: $(sudo systemctl is-active jenkins)"
          JENKINS_SCRIPT

      - name: Verify Jenkins is running
        run: |
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ec2-user@${{ steps.get-ip.outputs.ec2_ip }} \
            'sudo systemctl is-active jenkins && echo "‚úÖ Jenkins is active!" || echo "‚ö†Ô∏è  Jenkins status check"'

      - name: Print deployment summary
        if: always()
        run: |
          echo "======================================"
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "======================================"
          echo ""
          echo "üìä INFRASTRUCTURE:"
          echo "  EC2 IP: ${{ steps.get-ip.outputs.ec2_ip }}"
          echo "  EC2 Instance: Running"
          echo "  Docker: Installed ‚úÖ"
          echo "  Docker Compose: Installed ‚úÖ"
          echo "  Jenkins: Installed via GitHub Actions ‚úÖ"
          echo ""
          echo "üåê ACCESS JENKINS:"
          echo "  URL: http://${{ steps.get-ip.outputs.ec2_ip }}:8080"
          echo "  Port: 8080"
          echo ""
          echo "üìù NEXT STEPS:"
          echo "  1. Open http://${{ steps.get-ip.outputs.ec2_ip }}:8080 in browser"
          echo "  2. Jenkins will prompt for initial setup"
          echo "  3. Get admin password from: ssh and cat /var/lib/jenkins/secrets/initialAdminPassword"
          echo ""
          echo "======================================"
