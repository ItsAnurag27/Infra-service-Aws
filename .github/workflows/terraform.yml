name: Terraform Deploy AWS Services
#demo
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  TERRAFORM_VERSION: 1.6.0
  TF_VAR_github_token: ${{ secrets.DOCKER_GITHUB_TOKEN }}
  TF_VAR_github_username: ${{ secrets.DOCKER_GITHUB_USERNAME }}

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    name: Terraform Plan
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform
          terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        run: |
          echo "## Terraform Plan ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Plan Completed" >> $GITHUB_STEP_SUMMARY
          echo "Terraform plan completed successfully. Review the changes before merging." >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: terraform/tfplan
          retention-days: 5

  terraform-apply:
    runs-on: ubuntu-latest
    name: Terraform Apply
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: terraform/

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Apply
        id: apply
        run: |
          cd terraform
          terraform apply -no-color -auto-approve tfplan
        continue-on-error: true

      - name: Get Terraform Outputs
        if: steps.apply.outcome == 'success'
        run: |
          cd terraform
          echo "=== Terraform Outputs ===" >> $GITHUB_STEP_SUMMARY
          terraform output -no-color >> $GITHUB_STEP_SUMMARY

      - name: Notify Deployment Success
        if: steps.apply.outcome == 'success'
        run: |
          echo "âœ… AWS Infrastructure Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY

      - name: Notify Deployment Failure
        if: steps.apply.outcome == 'failure'
        run: |
          echo "âŒ AWS Infrastructure Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY

  post-deployment-setup:
    runs-on: ubuntu-latest
    name: Wait for EC2 & Install Services
    needs: terraform-apply
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Get EC2 Instance IP
        id: ec2
        run: |
          cd terraform
          EC2_IP=$(terraform output -raw ec2_instance_public_ips 2>/dev/null | head -1 || echo "")
          if [ -z "$EC2_IP" ]; then
            echo "â³ Waiting for EC2 instance public IP..."
            sleep 10
            EC2_IP=$(terraform output -raw ec2_instance_public_ips 2>/dev/null | head -1 || echo "")
          fi
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"

      - name: Wait for EC2 to be Active
        run: |
          EC2_IP="${{ steps.ec2.outputs.ec2_ip }}"
          echo "â³ Waiting for EC2 instance at $EC2_IP to be fully active..."
          
          # Wait for SSH to be available
          for i in {1..60}; do
            if timeout 5 bash -c "echo > /dev/tcp/$EC2_IP/22" 2>/dev/null; then
              echo "âœ… EC2 instance is active and SSH is available"
              exit 0
            fi
            echo "Attempt $i/60: Waiting for SSH availability..."
            sleep 10
          done
          
          echo "âŒ EC2 instance did not become active within timeout"
          exit 1

      - name: Install Docker & Docker Compose via SSH
        run: |
          EC2_IP="${{ steps.ec2.outputs.ec2_ip }}"
          
          echo "ðŸ“¦ Installing Docker and Docker Compose on EC2..."
          
          # Create installation script
          cat > /tmp/install-docker.sh << 'DOCKER_SCRIPT'
          #!/bin/bash
          set -e
          
          echo "Updating system packages..."
          sudo yum update -y
          
          echo "Installing Docker..."
          sudo amazon-linux-extras install docker -y
          
          echo "Starting Docker service..."
          sudo systemctl enable docker
          sudo systemctl start docker
          
          echo "Adding ec2-user to docker group..."
          sudo usermod -a -G docker ec2-user
          
          echo "Installing Docker Compose..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          
          echo "Verifying Docker installation..."
          docker --version
          docker-compose --version
          
          echo "âœ… Docker and Docker Compose installed successfully"
          DOCKER_SCRIPT
          
          chmod +x /tmp/install-docker.sh
          
          # Copy script to EC2 using SSH key from Terraform
          cd terraform
          SSH_KEY=$(terraform output -raw -json ec2_instance_ids 2>/dev/null | head -1)
          
          # For now, we'll notify about manual setup or use EC2 Instance Connect
          echo "ðŸ“ Docker installation script ready for EC2"
          echo "EC2 Instance: $EC2_IP"

      - name: Verify Jenkins is Running
        run: |
          EC2_IP="${{ steps.ec2.outputs.ec2_ip }}"
          
          echo "ðŸ” Checking Jenkins status on $EC2_IP:8080..."
          
          # Wait for Jenkins to be available
          for i in {1..30}; do
            if curl -s -f -m 5 "http://$EC2_IP:8080" > /dev/null 2>&1; then
              echo "âœ… Jenkins is running and accessible at http://$EC2_IP:8080"
              echo "Default credentials: admin / admin"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for Jenkins..."
            sleep 10
          done
          
          echo "âš ï¸ Jenkins may still be initializing. Check EC2 logs if needed."
          echo "EC2 Instance: $EC2_IP"
          echo "Jenkins URL: http://$EC2_IP:8080"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Post-Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**EC2 Instance IP:** ${{ steps.ec2.outputs.ec2_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "**Jenkins URL:** http://${{ steps.ec2.outputs.ec2_ip }}:8080" >> $GITHUB_STEP_SUMMARY
          echo "**Default Credentials:** admin / admin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Installed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Jenkins (Automated)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker (User Data)" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Compose (User Data)" >> $GITHUB_STEP_SUMMARY

  terraform-destroy-approval:
    runs-on: ubuntu-latest
    name: Destroy Approval (Manual)
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Destroy Plan
        run: |
          cd terraform
          terraform plan -destroy -no-color -out=tfplan-destroy

      - name: Request Approval
        run: |
          echo "ðŸš¨ Approval Needed: Terraform Destroy AWS Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A request to destroy AWS infrastructure has been initiated." >> $GITHUB_STEP_SUMMARY
          echo "Manual approval is required from maintainers before proceeding." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroy Plan Generated:** terraform/tfplan-destroy" >> $GITHUB_STEP_SUMMARY
